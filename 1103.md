# Protecci√≥n de datos con cifrado

**Ponderaci√≥n:** 3

**Descripci√≥n:** El candidato debe ser capaz de utilizar t√©cnicas de clave p√∫blica para proteger los datos y la comunicaci√≥n.

**√Åreas de conocimiento clave:**

* Configuraci√≥n y uso b√°sicos del cliente OpenSSH 2
* Comprender la funci√≥n de las claves de host del servidor OpenSSH 2
* Configuraci√≥n, uso y revocaci√≥n b√°sicos de GnuPG
* Comprender los t√∫neles de puerto SSH (incluidos los t√∫neles X11)

**T√©rminos y utilidades:**

* ssh
* ssh-keygen
* ssh-agent
* ssh-add
* \~/.ssh/id\_rsa and id\_rsa.pub
* \~/.ssh/id\_dsa and id\_dsa.pub
* /etc/ssh/ssh\_host\_rsa\_key and ssh\_host\_rsa\_key.pub
* /etc/ssh/ssh\_host\_dsa\_key and ssh\_host\_dsa\_key.pub
* \~/.ssh/authorized\_keys
* ssh\_known\_hosts
* gpg
* \~/.gnupg/


Primero, veamos algunos conceptos.

## Criptograf√≠a

La criptograf√≠a es un m√©todo que utiliza principios matem√°ticos avanzados para almacenar y transmitir datos en un formato espec√≠fico, de modo que solo quienes los reciben puedan leerlos y procesarlos. El cifrado es un concepto clave en criptograf√≠a.

* **Cifrado**: En criptograf√≠a, el cifrado es el proceso de codificar un mensaje o informaci√≥n de tal manera que solo las partes autorizadas puedan acceder a √©l, mientras que quienes no lo est√©n no lo puedan.
* **Descifrado**: La conversi√≥n de datos cifrados a su forma original se denomina descifrado. Generalmente, es el proceso inverso del cifrado.

### Cifrado sim√©trico vs. asim√©trico

Los algoritmos de cifrado se suelen dividir en dos categor√≠as: cifrado sim√©trico y asim√©trico.

#### Cifrado sim√©trico

![](assets/securedata-symetric.jpg)

El cifrado sim√©trico es la t√©cnica m√°s antigua y conocida. Se aplica una clave secreta, que puede ser un n√∫mero, una palabra o simplemente una cadena de letras aleatorias, al texto de un mensaje para modificar su contenido de una forma espec√≠fica. Esto puede ser tan simple como desplazar cada letra un n√∫mero determinado en el alfabeto. Siempre que tanto el remitente como el destinatario conozcan la clave secreta, podr√°n cifrar y descifrar todos los mensajes que la utilicen.

#### Cifrado asim√©trico

El problema con las claves secretas reside en su intercambio a trav√©s de Internet o de una gran red, evitando que caigan en manos indebidas. Cualquiera que conozca la clave secreta puede descifrar el mensaje. Una soluci√≥n es el cifrado asim√©trico, en el que existen dos claves relacionadas: un par de claves. Una clave p√∫blica est√° disponible gratuitamente para cualquiera que desee enviarte un mensaje. Una segunda clave, la privada, se mantiene en secreto, de modo que solo t√∫ la conoces.

![](assets/securedata-asymetric.jpg)

Cualquier mensaje (texto, archivos binarios o documentos) cifrado con la clave p√∫blica solo se puede descifrar aplicando el mismo algoritmo, pero con la clave privada correspondiente. Cualquier mensaje cifrado con la clave privada solo se puede descifrar con la clave p√∫blica correspondiente.

Esto significa que no tienes que preocuparte por pasar claves p√∫blicas por internet (se supone que las claves son p√∫blicas).

> Sin embargo, un problema del cifrado asim√©trico es que es m√°s lento que el cifrado sim√©trico. Requiere mucha m√°s potencia de procesamiento tanto para cifrar como para descifrar el contenido del mensaje.

**Cifrado vs. Firma**

Al cifrar, usas la **clave p√∫blica** para escribir un mensaje y la otra persona usa la **clave privada** para leerlo.

Al firmar, usas tu **clave privada** para escribir la firma del mensaje y la otra persona usa tu **clave p√∫blica** para comprobar si es realmente tuya.
#### ¬øQu√© es un servidor de claves?

Servidor de claves (criptogr√°fico), un servidor donde se almacenan claves p√∫blicas para uso de terceros.

Con esta introducci√≥n, hablemos de SSH.

## ¬øQu√© es SSH?

El protocolo SSH (tambi√©n conocido como Secure Shell) es un m√©todo para el inicio de sesi√≥n remoto seguro entre ordenadores. Ofrece varias opciones para una autenticaci√≥n robusta y protege la seguridad e integridad de las comunicaciones con un cifrado robusto. Es una alternativa segura a los protocolos de inicio de sesi√≥n no protegidos (como Telnet y Rlogin) y a los m√©todos de transferencia de archivos inseguros (como FTP).

Usos t√≠picos del protocolo SSH:

* Proporcionar acceso seguro a usuarios y procesos automatizados
* Transferencias de archivos interactivas y automatizadas
* Emitir comandos remotos
* Gestionar la infraestructura de red y otros componentes cr√≠ticos del sistema.

### ¬øC√≥mo funciona el protocolo SSH?

SSH funciona mediante un modelo cliente-servidor que permite la autenticaci√≥n de dos sistemas remotos y el cifrado de los datos que se transfieren entre ellos.

SSH opera en el puerto TCP 22 por defecto (aunque esto se puede cambiar si es necesario). El host (servidor) escucha las conexiones entrantes en el puerto 22 (o en cualquier otro puerto asignado a SSH).

SSH ofrece m√∫ltiples mecanismos para autenticar al servidor y al cliente. Dos de los mecanismos de autenticaci√≥n m√°s utilizados son la autenticaci√≥n basada en contrase√±a y la autenticaci√≥n basada en clave. Si bien la autenticaci√≥n basada en contrase√±a tambi√©n es segura, se recomienda utilizar la autenticaci√≥n basada en clave.

![](assets/ssh-howitworks.jpg)

La conexi√≥n se establece mediante el cliente SSH al conectarse al servidor SSH. El cliente SSH gestiona el proceso de configuraci√≥n de la conexi√≥n y utiliza criptograf√≠a de clave p√∫blica para verificar la identidad del servidor SSH. Tras la configuraci√≥n, el protocolo SSH utiliza un cifrado sim√©trico robusto y algoritmos hash para garantizar la privacidad e integridad de los datos que se intercambian entre el cliente y el servidor.

### ¬øQu√© es OpenSSH?

OpenSSH es una implementaci√≥n gratuita y de c√≥digo abierto del protocolo SSH (Secure Shell). OpenSSH es muy popular entre los administradores de sistemas gracias a su compatibilidad multiplataforma y sus pr√°cticas funciones.

![](assets/openssh-logo.png)

Todas las comunicaciones y credenciales de usuario que utilizan OpenSSH est√°n cifradas y protegidas contra ataques de intermediario. Si un tercero intenta interceptar nuestra conexi√≥n, OpenSSH lo detecta y nos informa.

Usamos Ubuntu 16-1 como servidor SSH y Ubuntu 16-2 como cliente.
#### /etc/ssh

OpenSSH tiene dos conjuntos de archivos de configuraci√≥n: uno para los programas cliente (ssh, scp y sftp) y otro para el demonio del servidor (sshd).

```
root@ubuntu16-1:~# ls -1 /etc/ssh
moduli
ssh_config
sshd_config
ssh_host_dsa_key
ssh_host_dsa_key.pub
ssh_host_ecdsa_key
ssh_host_ecdsa_key.pub
ssh_host_ed25519_key
ssh_host_ed25519_key.pub
ssh_host_rsa_key
ssh_host_rsa_key.pub
ssh_import_id
```

El archivo `sshd_config` es el archivo de configuraci√≥n del **daemon** ssh (o proceso del servidor ssh), mientras que el archivo `ssh_config` es el archivo de configuraci√≥n del cliente ssh. Este archivo solo influye al usar el comando ssh para conectarse a otro host ssh. Como puede ver, existen claves p√∫blicas y privadas con diferentes algoritmos que SSH puede usar para cifrar la sesi√≥n.

## Configuraciones del cliente ssh

Hasta ahora hemos comprendido c√≥mo funciona SSH. Como mencionamos, al iniciar una conexi√≥n ssh, la clave p√∫blica del servidor ssh se transfiere al cliente (almacenada en ./ssh/known\_hosts) y el cliente la usar√° para continuar la negociaci√≥n con el servidor. El usuario deber√° autenticarse enviando su nombre de usuario y contrase√±a.

Comencemos conect√°ndonos a Ubuntu 16-1 desde Ubuntu 16-2 y veamos las claves:

```
user1@ubuntu16-2:~$ ssh user1@192.168.52.146
The authenticity of host '192.168.52.146 (192.168.52.146)' can't be established.
ECDSA key fingerprint is SHA256:GV/PpX9YGvMZTAbuz6w3zBDreokesZHhVSM1zrXmHLw.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.52.146' (ECDSA) to the list of known hosts.
user1@192.168.52.146's password: 
Welcome to Ubuntu 16.04.5 LTS (GNU/Linux 4.15.0-39-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

445 packages can be updated.
365 updates are security updates.

New release '18.04.4 LTS' available.
Run 'do-release-upgrade' to upgrade to it.

Last login: Fri Mar 27 15:51:55 2020 from 192.168.52.133
user1@ubuntu16-1:~$ 
```

¬øQu√© es una huella digital? Una huella digital de clave p√∫blica es una secuencia corta de bytes que se utiliza para identificar una clave p√∫blica m√°s larga. Las huellas digitales se crean aplicando una funci√≥n hash criptogr√°fica a una clave p√∫blica. Dado que las huellas digitales son m√°s cortas que las claves a las que hacen referencia, pueden utilizarse para simplificar ciertas tareas de gesti√≥n de claves.

Ahora comparemos las claves en el servidor y el cliente:

```
### server
user1@ubuntu16-1:~$ cat /etc/ssh/ssh_host_ecdsa_key.pub 
ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBIjnKq9Wr0C2faQCf4+gcqPN4bOMFyx1nywTjLS/mh/S30V0r/mvy9cvfWvA2LY/y7zqxg+/gMvELQznikQiaTo= root@server1
```

```
### client
user1@ubuntu16-2:~$ tree .ssh/
.ssh/
‚îî‚îÄ‚îÄ known_hosts

0 directories, 1 file
user1@ubuntu16-2:~$ cat .ssh/known_hosts 
|1|gD2R1tW6jKBSyL1A0XpynmG8Vok=|1X2nzVcwHLQGT5T8FOUxeCejtvQ= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBIjnKq9Wr0C2faQCf4+gcqPN4bOMFyx1nywTjLS/mh/S30V0r/mvy9cvfWvA2LY/y7zqxg+/gMvELQznikQiaTo=
```

Configuraci√≥n de la autenticaci√≥n basada en clave SSH

Es posible omitir el nombre de usuario y la contrase√±a y conectarse al servidor SSH utilizando las claves p√∫blica y privada del cliente.

![](assets/ssh-keybasedauth.jpg)

Ahora, generemos las claves p√∫blicas y privadas del cliente y copiemos la clave p√∫blica del cliente al servidor.
### ssh-keygen

ssh-keygen: crea un par de claves para la autenticaci√≥n con clave p√∫blica:

```
user1@ubuntu16-2:~$ ssh-keygen 
Generating public/private rsa key pair.
Enter file in which to save the key (/home/user1/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/user1/.ssh/id_rsa.
Your public key has been saved in /home/user1/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:rer76yQU+8Mmrg33xCA51RtnpTUVHT1cVMX7kB2+aUI user1@ubuntu16-2
The key's randomart image is:
+---[RSA 2048]----+
|            +.+*@|
|       .   + . ++|
|      o o +   .o+|
|     o o *   Eoo.|
|    + + S . .  .+|
|     + = .   . +.|
|    . + X     o  |
|     = O .       |
|    .o*+=.       |
+----[SHA256]-----+
user1@ubuntu16-2:~$ 
user1@ubuntu16-2:~$ tree .ssh
.ssh
‚îú‚îÄ‚îÄ id_rsa
‚îú‚îÄ‚îÄ id_rsa.pub
‚îî‚îÄ‚îÄ known_hosts

0 directories, 3 files
user1@ubuntu16-2:~$ cat .ssh/id_rsa.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC818rxUXbwnwwxtFhUKvgtZV+Ygao1nUEHcaBvYEsXsBa4hQcV0+ITPEMHfk0zUag3sKyQZWckKmREK+lpiF+7Nrw83eKxjgHdwZC0ibxPTenklZNSBEMZMBDeq8H3bKoAfuyczX0IfVDA2Iyebsg2KYIIZQ/Otw7hAm2IH3perUqzeYliLhIYb0Gd3jyOpl4VMaPb2p+f5+fG87MnzjDplyorruhZyUcv8CMUc6XZ3dJjeiSsNNCRKLEb6Cm6msQxuCUq+Xz1n0+ay6fsaJbbhzFwNvbRH2YSzBg5BmtBXVt68U6XM3SzynWAqQaDS44Cuv3M1q88baTlOTjRkFRZ user1@ubuntu16-2
user1@ubuntu16-2:~$ 


```

No hemos establecido una contrase√±a en nuestra demostraci√≥n, pero si la estableci√©ramos, se nos solicitar√≠a que la introduj√©ramos al copiarla al servidor.

### ssh-copy-id

Usamos ssh-copy-id, que configura una clave p√∫blica como autorizada en un servidor.

```
user1@ubuntu16-2:~$ ssh-copy-id -i .ssh/id_rsa.pub user1@192.168.52.146
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: ".ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
user1@192.168.52.146's password: 

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh 'user1@192.168.52.146'"
and check to make sure that only the key(s) you wanted were added.
```

Ahora echemos un vistazo al lado del servidor:

```
user1@ubuntu16-1:~$ cat .ssh/authorized_keys 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC818rxUXbwnwwxtFhUKvgtZV+Ygao1nUEHcaBvYEsXsBa4hQcV0+ITPEMHfk0zUag3sKyQZWckKmREK+lpiF+7Nrw83eKxjgHdwZC0ibxPTenklZNSBEMZMBDeq8H3bKoAfuyczX0IfVDA2Iyebsg2KYIIZQ/Otw7hAm2IH3perUqzeYliLhIYb0Gd3jyOpl4VMaPb2p+f5+fG87MnzjDplyorruhZyUcv8CMUc6XZ3dJjeiSsNNCRKLEb6Cm6msQxuCUq+Xz1n0+ay6fsaJbbhzFwNvbRH2YSzBg5BmtBXVt68U6XM3SzynWAqQaDS44Cuv3M1q88baTlOTjRkFRZ user1@ubuntu16-2
```

Ahora vamos a comprobar el resultado de la cliente:

```
user1@ubuntu16-2:~$ ssh user1@192.168.52.146
Welcome to Ubuntu 16.04.5 LTS (GNU/Linux 4.15.0-39-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

445 packages can be updated.
365 updates are security updates.

New release '18.04.4 LTS' available.
Run 'do-release-upgrade' to upgrade to it.

Last login: Fri Mar 27 15:57:29 2020 from 192.168.52.133
user1@ubuntu16-1:~$ 

```

Y parece correcto. Podemos copiar y pegar las claves de otros usuarios si lo desea, pero no olvide que estas claves permiten a los usuarios iniciar sesi√≥n sin contrase√±a.

#### ¬øPor qu√© usar una frase de contrase√±a? ¬øPara qu√© sirve?

Hemos configurado una conexi√≥n SSH sin contrase√±a mediante autenticaci√≥n basada en clave. Pero ¬øqu√© pasar√≠a si nuestro sistema se viera comprometido? Un hacker malicioso podr√≠a conectarse a otros servidores mediante autenticaci√≥n basada en clave sin conocer las contrase√±as.

La frase de contrase√±a puede ayudarnos a evitar este tipo de problemas de seguridad al requerir una frase de contrase√±a al inicio de cada autenticaci√≥n SSH basada en clave. As√≠ que borremos la clave autorizada anterior y comencemos:

```
user1@ubuntu16-1:~$ 
user1@ubuntu16-1:~$ vim .ssh/authorized_keys 
user1@ubuntu16-1:~$ cat .ssh/authorized_keys 
user1@ubuntu16-1:~$ exit
logout
Connection to 192.168.52.146 closed.
```

Ahora genere un nuevo par de claves con frase de contrase√±a en el cliente (deje que sobrescriba la clave privada y p√∫blica actual):

```
user1@ubuntu16-2:~$ ssh-keygen 
Generating public/private rsa key pair.
Enter file in which to save the key (/home/user1/.ssh/id_rsa): 
/home/user1/.ssh/id_rsa already exists.
Overwrite (y/n)? y
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/user1/.ssh/id_rsa.
Your public key has been saved in /home/user1/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:NYUt7TiSY2pBH7jtmZqGDdV545CRZxTFvOg3KJ3trxo user1@ubuntu16-2
The key's randomart image is:
+---[RSA 2048]----+
|       . ooOo    |
|      o + =.=    |
|     . = Oo= .   |
|      + %.*.o    |
|     . =S@ *     |
|    . o = * +    |
|     = o .Eo .   |
|    . =    ..    |
|     .    ...o.  |
+----[SHA256]-----+
user1@ubuntu16-2:~$ 
user1@ubuntu16-2:~$ tree .ssh/
.ssh/
‚îú‚îÄ‚îÄ id_rsa
‚îú‚îÄ‚îÄ id_rsa.pub
‚îî‚îÄ‚îÄ known_hosts

0 directories, 3 files
user1@ubuntu16-2:~$ cat .ssh/id_rsa.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDjF4K2XDLQIysT9QvwQKFFvJ6LeBN3XsmEO9cTZfnRPhPjKOpcwvyCPaFJwXpiSXLE+RUjy2lwghZ6sOIXezGG9+oqkVegBOJ9RonQfvg5nUCr/Khx+dT/5ZV8JEjJVYqWnrgxKiKgzFHfzInE3qKG4kN2yuanomqIPFGQs0Mk/ShmYCPEEDIxyapRWkSJMa1OeS4/Elk1gGcna0TwgNVF8zmGkg5JO3ruwia2uSbdDWxA2vVtae2qA02lFh0Gb/LJO8vR24MAwlyMMHU2UdszA4eWqQBrZtpKmQ0A4plT8EUkh2cZHgaUeMVloWDmFRyiU2LIFgC5AacnwRIFTtTD user1@ubuntu16-2
user1@ubuntu16-2:~$ 
```

Ahora transfiramos nuestra nueva clave p√∫blica al servidor:

```
user1@ubuntu16-2:~$ ssh-copy-id -i .ssh/id_rsa.pub user1@192.168.52.146
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: ".ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
user1@192.168.52.146's password: 

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh 'user1@192.168.52.146'"
and check to make sure that only the key(s) you wanted were added.
```

Verifiquemos la clave que hemos copiado en el servidor:

```
user1@ubuntu16-1:~$ cat .ssh/authorized_keys 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDjF4K2XDLQIysT9QvwQKFFvJ6LeBN3XsmEO9cTZfnRPhPjKOpcwvyCPaFJwXpiSXLE+RUjy2lwghZ6sOIXezGG9+oqkVegBOJ9RonQfvg5nUCr/Khx+dT/5ZV8JEjJVYqWnrgxKiKgzFHfzInE3qKG4kN2yuanomqIPFGQs0Mk/ShmYCPEEDIxyapRWkSJMa1OeS4/Elk1gGcna0TwgNVF8zmGkg5JO3ruwia2uSbdDWxA2vVtae2qA02lFh0Gb/LJO8vR24MAwlyMMHU2UdszA4eWqQBrZtpKmQ0A4plT8EUkh2cZHgaUeMVloWDmFRyiU2LIFgC5AacnwRIFTtTD user1@ubuntu16-2
```

Ahora, cuando nos comunicamos por SSH con el servidor remoto (ubuntu16-1) desde nuestro cliente (ubuntu16-2), se nos solicita que ingresemos nuestra frase de contrase√±a de clave local en lugar de la contrase√±a de la cuenta de usuario remota:

```
user1@ubuntu16-2:~$ ssh user1@192.168.52.146
Enter passphrase for key '/home/user1/.ssh/id_rsa': 
Welcome to Ubuntu 16.04.5 LTS (GNU/Linux 4.15.0-39-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

445 packages can be updated.
365 updates are security updates.

New release '18.04.4 LTS' available.
Run 'do-release-upgrade' to upgrade to it.

Last login: Fri Mar 27 16:19:57 2020 from 192.168.52.133

```

salgamos y hagamos ssh una y otra vez:

```
user1@ubuntu16-1:~$ exit
logout
Connection to 192.168.52.146 closed.

user1@ubuntu16-2:~$ ssh user1@192.168.52.146
Enter passphrase for key '/home/user1/.ssh/id_rsa': 
Welcome to Ubuntu 16.04.5 LTS (GNU/Linux 4.15.0-39-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

445 packages can be updated.
365 updates are security updates.

New release '18.04.4 LTS' available.
Run 'do-release-upgrade' to upgrade to it.

Last login: Fri Mar 27 16:30:00 2020 from 192.168.52.133
user1@ubuntu16-1:~$ exit
logout
Connection to 192.168.52.146 closed.

```

Como pueden ver, cada vez que se nos solicita la contrase√±a, esto era lo que busc√°bamos para detener a un hacker si nuestro sistema se ve√≠a comprometido. Existe una forma de mantener la contrase√±a en la sesi√≥n actual del usuario y conservarla para las siguientes conexiones SSH, evitando as√≠ tener que volver a introducirla.

### ssh-agent

El **ssh-agent** es un programa auxiliar que registra las claves de identidad y las contrase√±as de los usuarios. El **agente** puede usar las claves para iniciar sesi√≥n en otros servidores sin que el usuario tenga que volver a introducir la contrase√±a o la contrase√±a. Esto implementa un tipo de inicio de sesi√≥n √∫nico (SSO). El agente SSH se utiliza para la autenticaci√≥n de clave p√∫blica SSH.

```
user1@ubuntu16-2:~$ ssh-agent
SSH_AUTH_SOCK=/tmp/ssh-7dlnU2k64PSA/agent.65150; export SSH_AUTH_SOCK;
SSH_AGENT_PID=65151; export SSH_AGENT_PID;
echo Agent pid 65151;
```

Si recibe un error, primero intente ejecutar ssh-agent /bin/bash.

### ssh-add

De forma predeterminada, el agente usa las claves SSH almacenadas en el directorio `.ssh`, dentro del directorio personal del usuario. El comando **ssh-add** se usa para agregar identidades al agente. En la forma m√°s simple, simplemente ejecute `if` sin argumentos para agregar los archivos predeterminados `~/.ssh/id_rsa`, `.ssh/id_dsa`, `~/.ssh/id_ecdsa`, `~/.ssh/id_ed25519` y `~/.ssh/identity`. De lo contrario, asigne como argumento el nombre del archivo de clave privada que se agregar√°.

```
user1@ubuntu16-2:~$ ssh-add 
Enter passphrase for /home/user1/.ssh/id_rsa: 
Identity added: /home/user1/.ssh/id_rsa (/home/user1/.ssh/id_rsa)

user1@ubuntu16-2:~$ ssh-add -l
2048 SHA256:NYUt7TiSY2pBH7jtmZqGDdV545CRZxTFvOg3KJ3trxo /home/user1/.ssh/id_rsa (RSA)
user1@ubuntu16-2:~$ 
```

`-l` listar√° las claves privadas actualmente accesibles para el agente.

`-D` Elimina todas las identidades del agente, si lo desea.

Y luego podemos iniciar sesi√≥n en el servidor OpenSSH (ubuntu 16-1) sin contrase√±a ni frase de contrase√±a una y otra vez:

```
user1@ubuntu16-2:~$ ssh user1@192.168.52.146
Welcome to Ubuntu 16.04.5 LTS (GNU/Linux 4.15.0-39-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

445 packages can be updated.
365 updates are security updates.

New release '18.04.4 LTS' available.
Run 'do-release-upgrade' to upgrade to it.

Last login: Fri Mar 27 16:31:26 2020 from 192.168.52.133
user1@ubuntu16-1:~$ exit
logout

```

Hasta que salgamos del bash que usa la clave asociada, necesitaremos ingresar la contrase√±a nuevamente.

#### ¬øQu√© es la tunelizaci√≥n SSH?

La tunelizaci√≥n SSH es un m√©todo para transportar datos de red arbitrarios a trav√©s de una conexi√≥n SSH cifrada. Se puede usar para agregar cifrado a aplicaciones heredadas. Tambi√©n se puede usar para implementar VPN (redes privadas virtuales) y acceder a servicios de intranet a trav√©s de firewalls.

SSH es un est√°ndar para inicios de sesi√≥n remotos seguros y transferencias de archivos a trav√©s de redes no confiables. Tambi√©n proporciona una forma de proteger el tr√°fico de datos de cualquier aplicaci√≥n mediante el reenv√≠o de puertos, b√°sicamente tunelizando cualquier puerto TCP/IP a trav√©s de SSH. Esto significa que el tr√°fico de datos de la aplicaci√≥n se dirige dentro de una conexi√≥n SSH cifrada para que no pueda ser interceptado mientras est√° en tr√°nsito. La tunelizaci√≥n SSH permite agregar seguridad de red a aplicaciones heredadas que no admiten cifrado de forma nativa.

![](assets/ssh-tunneling.jpg)

¬øQu√© es el reenv√≠o de puertos SSH?

El reenv√≠o de puertos SSH es un mecanismo en SSH para tunelizar los puertos de las aplicaciones desde el equipo cliente al servidor, o viceversa. Algunos administradores de sistemas y profesionales de TI lo utilizan para abrir puertas traseras a la red interna desde sus equipos dom√©sticos. Tambi√©n puede ser utilizado por hackers y malware para abrir acceso desde Internet a la red interna.

Existen tres tipos de reenv√≠o de puertos SSH:

* **Reenv√≠o de puertos local**: las conexiones de un cliente SSH se reenv√≠an, a trav√©s del servidor SSH, a un servidor de destino.

![](assets/ssh-portfwl1.jpg)

![](assets/ssh-portfwl2.jpg)

* **Reenv√≠o de puerto remoto**: las conexiones desde un servidor SSH se reenv√≠an, a trav√©s del cliente SSH, a un servidor de destino

![](assets/ssh-portfwlr1.jpg)

![](assets/ssh-portfwlr2.jpg)
**Reenv√≠o din√°mico de puertos**: las conexiones de varios programas se reenv√≠an, a trav√©s del cliente SSH, a un servidor SSH y, finalmente, a varios servidores de destino.

### ssh

Al igual que otros comandos, ssh tambi√©n tiene algunas opciones. Veamos las opciones m√°s √∫tiles:

| Comandos SSH | Descripci√≥n |
| ---------------------------------------- | ----------------------------------------------------------------------------------------------------------------- |
| ssh -V | Muestra la versi√≥n del cliente SSH |
| ssh usuario1@servidor1.ejemplo.com | Conectar al host remoto; a√±adir "-v" para el modo detallado |
| ssh -l login\_name servidor1.ejemplo.com | Especifica el usuario con el que se iniciar√° sesi√≥n en la m√°quina remota. |
| ssh usuario1@servidor1.ejemplo.com \<comando> | Ejecutar \<comando> en el host remoto mediante ssh |
| ssh -X usuario@servidor1.ejemplo.com | Habilite Xforwarding en el lado del cliente. X11Forwarding debe estar habilitado en el lado del servidor en el archivo sshd\_config. |

## cifrado de datos

El cifrado **es importante** porque permite proteger de forma segura los datos a los que no desea que nadie m√°s tenga acceso.

### gpg

GnuPG (m√°s conocido como GPG) es una implementaci√≥n del est√°ndar PGP (Pretty Good Privacy). Utiliza un sistema de claves p√∫blicas y privadas para el cifrado y la firma de mensajes o datos.

Para la demostraci√≥n, utilizamos dos usuarios en Ubuntu 16: usuario1 y usuario2.

![](assets/securedata-gpgencrypt.jpg)

Ok, iniciemos sesi√≥n a trav√©s del usuario1 y comencemos a crear pares de claves usando el comando `gpg --gen-key`:

```
user1@ubuntu16-1:~$ gpg --gen-key 
gpg (GnuPG) 1.4.20; Copyright (C) 2015 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

gpg: keyring `/home/user1/.gnupg/secring.gpg' created
Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
Your selection? 1
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 
Requested keysize is 2048 bits
Please specify how long the key should be valid.
         0 = key does not expire
      <n>  = key expires in n days
      <n>w = key expires in n weeks
      <n>m = key expires in n months
      <n>y = key expires in n years
Key is valid for? (0) 
Key does not expire at all
Is this correct? (y/N) y

You need a user ID to identify your key; the software constructs the user ID
from the Real Name, Comment and Email Address in this form:
    "Heinrich Heine (Der Dichter) <heinrichh@duesseldorf.de>"

Real name: RealUser1
Email address: user1@localhost
Comment: created by user1
You selected this USER-ID:
    "RealUser1 (created by user1) <user1@localhost>"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o
You need a Passphrase to protect your secret key.

We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
.+++++
+++++
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.

Not enough random bytes available.  Please do some other work to give
the OS a chance to collect more entropy! (Need 74 more bytes)
....+++++

gpg: key 6D187851 marked as ultimately trusted
public and secret key created and signed.

gpg: checking the trustdb
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
pub   2048R/6D187851 2020-03-28
      Key fingerprint = 8772 5C1E 3F2F 88DB DBB7  7F37 E06C 3317 6D18 7851
uid                  RealUser1 (created by user1) <user1@localhost>
sub   2048R/F00A0A74 2020-03-28
```

Crea claves dentro del directorio \~/.gnupg. Veamos el par de claves creado con el comando `gpg --list-key`:

```
user1@ubuntu16-1:~$ gpg --list-key
/home/user1/.gnupg/pubring.gpg
------------------------------
pub   2048R/6D187851 2020-03-28
uid                  RealUser1 (created by user1) <user1@localhost>
sub   2048R/F00A0A74 2020-03-28
```

Luego, necesitamos compartir nuestra clave p√∫blica con otras personas. Para exportar nuestro archivo de clave p√∫blica, ejecutamos:

```
user1@ubuntu16-1:~$ gpg --export RealUser1 > user1.pub
```

Vamos a ponerlo en el directorio /tmp para el usuario2:

```
user1@ubuntu16-1:~$ mv user1.pub /tmp/
```

Ahora inicie sesi√≥n como usuario2 e importe la clave p√∫blica del usuario1 a trav√©s de `gpg --import`:

```
user2@ubuntu16-1:~$ gpg --import /tmp/user1.pub 
gpg: directory `/home/user2/.gnupg' created
gpg: new configuration file `/home/user2/.gnupg/gpg.conf' created
gpg: WARNING: options in `/home/user2/.gnupg/gpg.conf' are not yet active during this run
gpg: keyring `/home/user2/.gnupg/secring.gpg' created
gpg: keyring `/home/user2/.gnupg/pubring.gpg' created
gpg: /home/user2/.gnupg/trustdb.gpg: trustdb created
gpg: key 6D187851: public key "RealUser1 (created by user1) <user1@localhost>" imported
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)
```

A continuaci√≥n, cree un archivo de muestra para cifrar:

```
user2@ubuntu16-1:~$ vim user2file 
user2@ubuntu16-1:~$ cat user2file 
water boils at 100 degrees celsius!
```

Todo est√° listo para cifrar el archivo user2:

```
### list keys
user2@ubuntu16-1:~$ gpg --list-key
/home/user2/.gnupg/pubring.gpg
------------------------------
pub   2048R/6D187851 2020-03-28
uid                  RealUser1 (created by user1) <user1@localhost>
sub   2048R/F00A0A74 2020-03-28
```

```
### encrypt
user2@ubuntu16-1:~$ gpg --output user2secret --recipient Realuser1 --encrypt user2file
gpg: F00A0A74: There is no assurance this key belongs to the named user

pub  2048R/F00A0A74 2020-03-28 RealUser1 (created by user1) <user1@localhost>
 Primary key fingerprint: 8772 5C1E 3F2F 88DB DBB7  7F37 E06C 3317 6D18 7851
      Subkey fingerprint: 28DD 00C2 443C EA3B CD1A  9D5F 901E 5A02 F00A 0A74

It is NOT certain that the key belongs to the person named
in the user ID.  If you *really* know what you are doing,
you may answer the next question with yes.

Use this key anyway? (y/N) y
```

```
### take a look at inside encrypted file!
user2@ubuntu16-1:~$ cat user2secret 
ÔøΩ
  ÔøΩZÔøΩ

tÔøΩ}ÔøΩD?ÔøΩYÔøΩÔøΩÔøΩKy
               ÔøΩÔøΩ∆∏ÔøΩTB$+ÔøΩÔøΩ!ÔøΩMÔøΩzÔøΩ(ÔøΩs}jcÔøΩ_ÔøΩ#,$uÔøΩzÔøΩÔøΩ]ÔøΩKÔøΩK‹ÆÔøΩHÔøΩgÔøΩÔøΩÔøΩmÀöÔøΩoÔøΩÔøΩÔøΩ^;JÔøΩÔøΩIvIÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ ÔøΩ&(ÔøΩÔøΩÔøΩWÔøΩÔøΩY'YÔøΩMm,ÔøΩÔøΩÔøΩ*ÔøΩÔøΩÔøΩF)ÔøΩÔøΩ-ÔøΩÔøΩ$vjÔøΩUÚ≥∂úmÔøΩÔøΩÔøΩÔøΩMÔøΩÔøΩÔøΩ(XrÔøΩÔøΩÔøΩÔøΩÔøΩIÔøΩ+HÔøΩkoÔøΩ%k^ÔøΩÔøΩLﬂç5hÔøΩ7ÔøΩsÔøΩ[ÔøΩN.2 oÔøΩfeÔøΩd ÔøΩÔøΩÔøΩ≈ªÔøΩ[D”øÔøΩ'ÔøΩ^ÔøΩf‚≥êKn{AS&#,ÔøΩÔøΩÃä⁄öÔøΩÔøΩ}ÔøΩ5ÔøΩ!01e;ƒíÔøΩhÔøΩj1ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩJktÔøΩÔøΩVY6ÔøΩÔøΩÔøΩkÔøΩHÔøΩﬂ≥ÔøΩrtÔøΩ-nA
      ?gz»¨ÔøΩÔøΩ#j1)]
(ÔøΩ
  LÔøΩ1EyÔøΩÔøΩÔøΩCJÔøΩƒ¨ÔøΩc—ÉkÔøΩÔøΩQPÔøΩ
                             I2y_ÔøΩÔøΩÔøΩ8GÔøΩ¬õuser2@ubuntu16-1:~$ 
```

Es hora de enviar el secreto del usuario 2 al usuario 1:

```
user2@ubuntu16-1:~$ mv user2secret /tmp/
```

Inicie sesi√≥n como usuario1 e intente descifrar el secreto del usuario2:

```
user1@ubuntu16-1:~$ gpg --out from_user2 --decrypt /tmp/user2secret 

You need a passphrase to unlock the secret key for
user: "RealUser1 (created by user1) <user1@localhost>"
2048-bit RSA key, ID F00A0A74, created 2020-03-28 (main key ID 6D187851)

gpg: encrypted with 2048-bit RSA key, ID F00A0A74, created 2020-03-28
      "RealUser1 (created by user1) <user1@localhost>"
```

¬øVeamos cu√°l es la informaci√≥n secreta del usuario2?

```
user1@ubuntu16-1:~$ cat from_user2 
water boils at 100 degrees celsius!
```

Generaci√≥n de un certificado de revocaci√≥n

Si otros usuarios conocen su clave privada, deber√° desvincular las claves antiguas de su identidad para poder generar las nuevas. Para ello, necesitar√° un certificado de revocaci√≥n. Lo haremos ahora y lo guardaremos en un lugar seguro.

```
user1@ubuntu16-1:~$ gpg --output revoke_User1.crt --gen-revoke user1@localhost

sec  2048R/6D187851 2020-03-28 RealUser1 (created by user1) <user1@localhost>

Create a revocation certificate for this key? (y/N) y
Please select the reason for the revocation:
  0 = No reason specified
  1 = Key has been compromised
  2 = Key is superseded
  3 = Key is no longer used
  Q = Cancel
(Probably you want to select 1 here)
Your decision? 0
Enter an optional description; end it with an empty line:
> 
Reason for revocation: No reason specified
(No description given)
Is this okay? (y/N) y

You need a passphrase to unlock the secret key for
user: "RealUser1 (created by user1) <user1@localhost>"
2048-bit RSA key, ID 6D187851, created 2020-03-28

ASCII armored output forced.
Revocation certificate created.

Please move it to a medium which you can hide away; if Mallory gets
access to this certificate he can use it to make your key unusable.
It is smart to print this certificate and store it away, just in case
your media become unreadable.  But have some caution:  The print system of
your machine might store the data and make it available to others!
```

La opci√≥n `--output` debe ir seguida del nombre de archivo del certificado que desea crear. La opci√≥n `--gen-revoke` hace que `gpg` genere un certificado de revocaci√≥n. Debe proporcionar la direcci√≥n de correo electr√≥nico que utiliz√≥ para generar las claves.

```
user1@ubuntu16-1:~$ cat revoke_User1.crt 
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1
Comment: A revocation certificate should follow

iQEfBCABAgAJBQJef1iqAh0AAAoJEOBsMxdtGHhRuU0H/RHrxodSkniRE+iD15PW
dfcWcPZVAv9m2SWzmPN0vU/ywgUE5G60pNsOC6bxWbtmxbxm/PutCA+ipC/KPTcZ
RwZvU8ge0PLulrQ5km9xea2295b2dOBEPCzOkgv6BTeAMADrBmi2shhLqUWeoRRr
7H6oTC6RFr76o1jPb9UUMVDh840ttMlpYPAlir6JqCvwSL2ZJE58vWSuC/rou1ds
4Z1Q0EFjpMQ5S1TmukVF4h4xxGsiZpgoubKJb++1CtYfqoPgCV/yiQFjaSGdiQbL
0uqjfEERjOUUc5FKAY9fmvfAjmRzUBhit1U9wWiQ7O+JBxzMUDda3eas5OzpweeK
0Lw=
=z2hv
-----END PGP PUBLIC KEY BLOCK-----
```

## firma

Al cifrar un documento con tu clave privada, permites que cualquiera pueda intentar abrirlo con tu clave p√∫blica. Si lo logran, estar√°n seguros de que lo has firmado con tu clave privada. `gpg` tiene un comando espec√≠fico para firmar documentos:

```
user1@ubuntu16-1:~$ vim notice
user1@ubuntu16-1:~$ cat notice 
Lets start learning LPIC-2!
user1@ubuntu16-1:~$ 
user1@ubuntu16-1:~$ gpg --clearsign notice

You need a passphrase to unlock the secret key for
user: "RealUser1 (created by user1) <user1@localhost>"
2048-bit RSA key, ID 6D187851, created 2020-03-28
```

Aqu√≠, la instrucci√≥n --clearsign indica a gpg que incluya tambi√©n el mensaje de texto sin cifrar en el archivo de salida. El archivo de salida ser√° `originalfile.asc`:

```
user1@ubuntu16-1:~$ cat notice.asc 
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Lets start learning LPIC-2!
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1

iQEcBAEBAgAGBQJef2DyAAoJEOBsMxdtGHhReQoH/j33csnEJUlS6IqdlzeIDyw3
D6HVli8TaywfdZLTCXhSRHNM7NISCIsPdULHVs1J8vwYKLqshNOlx7F+HNAmkYtv
WqHlNL03x2TOEca+qr31iUFdtpRKrMsQ3mpai2aaI8MoILO1gRYGMZ717O31YGGh
yQ5Teft6q2QorWXpbACN0JlWcKs5OiFCgcCOOp2RHnjM4NtCJEmI+ZGBuqVJL98P
Aa/fP5AteexMuj4GwRfC542f9Tsaw03je4SlAcgq7cJ+iwpy5vHGwN0sPwbRoqbS
ABL1zaTA2TZmnS5Jx5ii8IyndObuVHtDUEGROaqxiVWZ/JrMAAfAjtv/mnL79HQ=
=W+EU
-----END PGP SIGNATURE-----
```

Copie el archivo notice.asc en /tmp y otros usuarios podr√°n verificar que un documento est√© firmado correctamente:

```
user2@ubuntu16-1:~$ gpg --verify /tmp/notice.asc 
gpg: Signature made Sat 28 Mar 2020 07:06:34 PM +0430 using RSA key ID 6D187851
gpg: Good signature from "RealUser1 (created by user1) <user1@localhost>"
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: 8772 5C1E 3F2F 88DB DBB7  7F37 E06C 3317 6D18 7851
user2@ubuntu16-1:~$ 
```

¬°Y eso es todo, amigos!

¬°Felicidades, hemos completado lpic1-102!


- [https://www.ssl2buy.com/wiki/symmetric-vs-asymmetric-encryption-what-are-differences](https://www.ssl2buy.com/wiki/symmetric-vs-asymmetric-encryption-what-are-differences)
- [https://hackernoon.com/symmetric-and-asymmetric-encryption-5122f9ec65b1](https://hackernoon.com/symmetric-and-asymmetric-encryption-5122f9ec65b1)
- [https://economictimes.indiatimes.com/definition/decryption](https://economictimes.indiatimes.com/definition/decryption)
- [https://support.microsoft.com/en-us/help/246071/description-of-symmetric-and-asymmetric-encryption](https://support.microsoft.com/en-us/help/246071/description-of-symmetric-and-asymmetric-encryption)
- [https://stackoverflow.com/questions/454048/what-is-the-difference-between-encrypting-and-signing-in-asymmetric-encryption](https://stackoverflow.com/questions/454048/what-is-the-difference-between-encrypting-and-signing-in-asymmetric-encryption)
- [https://en.wikipedia.org/wiki/Key\_server](https://en.wikipedia.org/wiki/Key\_server)
- [https://www.ssh.com/ssh/protocol](https://www.ssh.com/ssh/protocol)
- [https://www.hivelocity.net/kb/what-is-openssh/](https://www.hivelocity.net/kb/what-is-openssh/)
- [https://www.ssh.com/ssh/agent](https://www.ssh.com/ssh/agent)
- [https://www.ssh.com/ssh/tunneling](https://www.ssh.com/ssh/tunneling)
- [https://www.ssh.com/ssh/tunneling/example](https://www.ssh.com/ssh/tunneling/example)
- [https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot](https://unix.stackexchange.com/questions/115897/whats-ssh-port-forwarding-and-whats-the-difference-between-ssh-local-and-remot)
- [https://www.ssh.com/ssh/command](https://www.ssh.com/ssh/command)
- [https://www.taoeffect.com/espionage/EspionageHelp/pages/faq-encryption.html](https://www.taoeffect.com/espionage/EspionageHelp/pages/faq-encryption.html)
- [https://www.privex.io/articles/what-is-gpg/](https://www.privex.io/articles/what-is-gpg/)
- [https://www.howtogeek.com/427982/how-to-encrypt-and-decrypt-files-with-gpg-on-linux/](https://www.howtogeek.com/427982/how-to-encrypt-and-decrypt-files-with-gpg-on-linux/)
- [https://jadi.gitbooks.io/lpic1/content/1103\_securing\_data\_with\_encryption.html](https://jadi.gitbooks.io/lpic1/content/1103\_securing\_data\_with\_encryption.html)
